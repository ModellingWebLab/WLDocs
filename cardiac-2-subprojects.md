# Cardiac Electrophysiology Web Lab implementation

This document deals with the _implementation_ of the cardiac electrophysiology (CE) parts of the Web Lab (WL).
For a description of the generic Web Lab implementation, see [here](infrastructure.md).
For information on using the Cardiac Electrophysiology Web Lab (CEWL), see [here](README.md).


## Components

The CEWL is implemented using a number of re-usable Python modules.
While some of these modules depend on each other, they are written to be relatively independent of the Web Lab front-end.

* **`cellmlmanip`**: Reads a CellML model and generates a directed acyclical graph of its equations, which users can query via its API.
* **`fccodegen`**: Uses `cellmlmanip` to read CellML files and then generate CEWL model code. Code generation is based on templating, so it should be possible to adapt this into a general purpose CellML-to-code converter.
* **`fc`**: Functional curation library. Reads FC protocols and runs simulations with models (generated by `fccodegen`) to generate results.


### CellMLManip

See: https://github.com/ModellingWebLab/cellmlmanip


### fccodegen

See: https://github.com/ModellingWebLab/fccodegen


## fc

See: https://github.com/ModellingWebLab/weblab-fc

Uses Cython a lot: http://docs.cython.org/en/latest/src/userguide/language_basics.html#language-basics

Rough outline (**not finished**):

 - `Model` objects own a `Solver` that can be used to run simulations. They maintain a state, list of outputs, a list of parameters and a free variable that are publically accessible.
 - `Environment` objects map oxmeta variables to model variables, allow changes to models to be made
 - `Protocol` objects own `Models` and `Environments` and can manipulate models (through their environment) and solve model.
 - `Simulation` runs a protocol?



















# Cardiac Electrophysiology Web Lab infrastructure

This document describes the infrastructure that is specific to the Cardiac Electrophysiology Web Lab.
The generic Web Lab infrastructure is defined [here](./infrastructure.md).

## Models

Models are implemented in CellML.

In the future, they will be converted to [SymPy](https://www.sympy.org/en/docs.html) expressions using [cellmlmanip](https://github.com/ModellingWebLab/cellmlmanip) (with units handled in [pint](https://pint.readthedocs.io)).
The resulting 

## Protocols

Protocols are written in functional curation syntax (see below).

## Functional curation

Web Lab experiments run `Functional curation` with a model and protocol.

### FC-Runner

The Celery task to run experiments this is stored in the [fc-runner](https://github.com/ModellingWebLab/fc-runner/tree/master/fcws) repository.
The task checks input from the web interface, and fires off the `fc` experiment.
When completed, it packs up the results and sends them back to the web interface.

### FC

The actual experiment running code is stored in the [weblab-fc](https://github.com/ModellingWebLab/weblab-fc) repository.

This repo contains the Python `fc` module, which is at the heart of the cardiac EP Web Lab.
It:

- Parses CellML models.
  - Currently this is handled by PyCml, but we are converting to [cellmlmanip](https://github.com/ModellingWebLab/cellmlmanip).
- Parses FC protocols (using fc's `CompactSyntaxParser` module)
- Checks model and protocol compatibility
- Manipulates the model, e.g. adding/removing variables or stimulus protocols
  - Again should transition from PyCml to cellmlmanip
- Generates model-specific Python code (extending the `fc` `AbstractModel` class) that can run simulations.
  - Currently this is handled by PyCml, but we are converting to [weblab-cg](https://github.com/ModellingWebLab/weblab-cg).
  - Simulations are run in CVODE, using Cython to interface with it.
- Executes the protocol

For more information, see [https://chaste.cs.ox.ac.uk/trac/wiki/FunctionalCuration/ProtocolSyntax].

## Web Lab without FC?

At the start of the project, we discussed allowing arbitrary Python scripts, running in some kind of sandbox.
We should probably still look into this, as users will want to implement their own pre- and post-processing methods, at least.

Update: Jonathan says
> This was not so much 'without FC' but extending FC to allow Python for post-processing etc not just the domain-specific language.

## Fitting

Fitting will be handled using [PINTS](https://github.com/pints-team/pints).

